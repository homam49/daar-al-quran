# تعليمات إعداد التحقق من البريد الإلكتروني واستعادة كلمة المرور

تم الآن تنفيذ نظام للتحقق من البريد الإلكتروني واستعادة كلمة المرور لكل من المستخدمين (المشرفين والمعلمين والمشرفين) والطلاب. 

## متطلبات التكوين

لكي يعمل هذا النظام، يجب عليك تكوين إعدادات البريد الإلكتروني في ملف `.env` الخاص بك. يرجى إضافة/تحديث الإعدادات التالية:

### إعداد Mailtrap للاختبار (موصى به)

للاختبار، نوصي باستخدام Mailtrap:

1. قم بإنشاء حساب مجاني على [Mailtrap.io](https://mailtrap.io/)
2. بعد تسجيل الدخول، انتقل إلى علامة التبويب "Email Testing"
3. انقر على صندوق البريد الوارد الافتراضي (أو أنشئ واحدًا جديدًا)
4. انقر على علامة التبويب "SMTP Settings"
5. اختر "Laravel" من القائمة المنسدلة "Integrations"
6. انسخ إعدادات SMTP المقدمة وقم بتحديث ملف `.env` الخاص بك:

```
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=your_mailtrap_username
MAIL_PASSWORD=your_mailtrap_password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=no-reply@daaralquran.com
MAIL_FROM_NAME="دار القرآن"
```

### إعداد Gmail للاستخدام في الإنتاج

لاستخدام Gmail في الإنتاج:

```
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=no-reply@daaralquran.com
MAIL_FROM_NAME="دار القرآن"

# بالنسبة لـ Gmail:
# 1. قم بتمكين التحقق بخطوتين في حساب Google الخاص بك
# 2. قم بإنشاء كلمة مرور للتطبيق: حساب Google > الأمان > كلمات مرور التطبيقات
# 3. استخدم كلمة مرور التطبيق هذه كـ MAIL_PASSWORD الخاص بك
```

## تهيئة البريد الإلكتروني

بعد تكوين إعدادات البريد الإلكتروني، قم بتشغيل الأوامر التالية لتحديث التطبيق:

```bash
php artisan config:cache
php artisan view:cache
php artisan route:cache
```

## كيفية استخدام النظام

بعد التكوين، ستعمل الميزات التالية:

### للمستخدمين (المشرفين والمعلمين والمشرفين):

1. **التحقق من البريد الإلكتروني**: عند التسجيل، سيتلقى المستخدمون بريدًا إلكترونيًا للتحقق من عنوان بريدهم الإلكتروني.
2. **إعادة تعيين كلمة المرور**: يمكن للمستخدمين النقر على رابط "نسيت كلمة المرور؟" في صفحة تسجيل الدخول لإعادة تعيين كلمة المرور.

### للطلاب:

1. **التحقق من البريد الإلكتروني**: يمكن للطلاب التحقق من عنوان بريدهم الإلكتروني من خلال رابط التحقق المرسل إليهم.
2. **إعادة تعيين كلمة المرور**: يمكن للطلاب النقر على رابط "نسيت كلمة المرور؟" في صفحة تسجيل دخول الطالب لإعادة تعيين كلمة المرور.

## تفاصيل التنفيذ

1. تم تحديث نماذج المستخدم والطالب لدعم التحقق من البريد الإلكتروني وإعادة تعيين كلمة المرور.
2. تمت إضافة وحدات تحكم جديدة للتعامل مع التحقق من البريد الإلكتروني وإعادة تعيين كلمة المرور.
3. تمت إضافة جداول قاعدة بيانات جديدة لتخزين رموز إعادة تعيين كلمة المرور.
4. تمت إضافة قوالب عرض جديدة لصفحات إعادة تعيين كلمة المرور والتحقق من البريد الإلكتروني.
5. تم تحديث المسارات لدعم التحقق من البريد الإلكتروني وإعادة تعيين كلمة المرور.

## اختبار إرسال البريد الإلكتروني

مع Mailtrap، يمكنك اختبار إرسال البريد الإلكتروني دون إرسال رسائل بريد إلكتروني فعلية إلى المستخدمين:

1. قم بتسجيل مستخدم جديد في النظام
2. تحقق من صندوق الوارد Mailtrap الخاص بك - يجب أن ترى بريدًا إلكترونيًا للتحقق هناك
3. انقر على رابط التحقق للتأكد من أنه يعمل بشكل صحيح
4. اختبر أيضًا وظيفة "نسيت كلمة المرور"

## استكشاف الأخطاء وإصلاحها

إذا كنت تواجه مشكلات في إرسال رسائل البريد الإلكتروني:

1. تأكد من أن إعدادات البريد الإلكتروني صحيحة في ملف `.env` الخاص بك.
2. تحقق من سجلات التطبيق للحصول على أي رسائل خطأ: `storage/logs/laravel.log`.
3. إذا كنت تستخدم Mailtrap، تأكد من تحديث الاعتمادات الخاصة بك وتحقق من لوحة معلومات Mailtrap للتأكد من وصول الرسائل.
4. قم بتشغيل الأمر `php artisan optimize:clear` لمسح جميع ذاكرات التخزين المؤقت للتطبيق.

## تعيين المستخدمين الحاليين كمستخدمين تم التحقق منهم

لتجنب مشكلات المستخدمين الحاليين، قمنا بإنشاء بترحيل يُعيّن جميع المستخدمين الحاليين على أنهم تم التحقق منهم:

```php
// database/migrations/yyyy_mm_dd_mark_existing_users_as_verified.php
public function up()
{
    // Mark all existing users as verified
    DB::table('users')
        ->whereNull('email_verified_at')
        ->update(['email_verified_at' => now()]);

    // Mark all existing students as verified
    DB::table('students')
        ->whereNull('email_verified_at')
        ->update(['email_verified_at' => now()]);
}
```

المستخدمون الجدد فقط سيحتاجون إلى التحقق من بريدهم الإلكتروني عند التسجيل.

## مزودو البريد الإلكتروني الموصى بهم

1. **Gmail**: يعمل بشكل جيد مع إعداد كلمة مرور التطبيق كما هو موضح أعلاه.
2. **Mailgun**: خدمة بريد موثوقة لإرسال رسائل البريد الإلكتروني من التطبيقات.
3. **Amazon SES**: حل البريد الإلكتروني القابل للتطوير من AWS.
4. **Mailtrap**: أداة ممتازة للاختبار في بيئات التطوير.

بعد تكوين إعدادات البريد الإلكتروني بشكل صحيح، يجب أن يعمل نظام التحقق من البريد الإلكتروني واستعادة كلمة المرور بسلاسة. 